
<!DOCTYPE html>
<html>
<head>
    <title>Interactive Fire Response System - Table Mountain</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 70vh; width: 100%; }
        #control-panel { padding: 20px; background: #f0f0f0; height: 30vh; overflow-y: auto; }
        .fire-info { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; 
                     border-left: 4px solid #ff4444; }
        .recommendation { background: #e8f4ff; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .vehicle-deployment { background: #fff2e8; padding: 8px; margin: 3px 0; border-radius: 3px; }
        .status-active { border-left-color: #ff4444; }
        .status-contained { border-left-color: #ffaa44; }
        .status-extinguished { border-left-color: #44ff44; }
        .click-instruction { background: #ffffcc; padding: 15px; margin: 10px 0; 
                             border-radius: 5px; text-align: center; font-weight: bold; }
        .multi-fire-coordination { background: #fff3e0; padding: 15px; margin: 10px 0; 
                                   border-radius: 5px; border-left: 4px solid #ff9800; }
    </style>
</head>
<body>
    <div id="control-panel">
        <h2>🔥 Interactive Fire Response System - Multi-Fire Coordination</h2>
        <div class="click-instruction">
            Click anywhere on the map to start a fire and receive AI response recommendations with multi-fire coordination!
        </div>
        <div id="fire-status">
            <p><em>No active fires. Click on the map to simulate a fire incident.</em></p>
        </div>
    </div>
    
    <div id="map"></div>
    
    <script>
        // Initialize map centered on Table Mountain
        var map = L.map('map').setView([-33.95, 18.43], 12);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Fire stations data
        var fireStations = {"roeland_street": {"name": "Roeland Street Fire Station", "lat": -33.926, "lon": 18.421, "vehicles": ["Heavy-Duty Fire Engine", "Rapid Intervention Vehicle", "Incident Command Vehicle"], "response_time_base": 5, "coverage_radius": 8}, "sea_point": {"name": "Sea Point Fire Station", "lat": -33.921, "lon": 18.384, "vehicles": ["4x4 Wildland Vehicle", "Water Tanker", "CAFS Unit"], "response_time_base": 6, "coverage_radius": 7}, "constantia": {"name": "Constantia Fire Station", "lat": -34.004, "lon": 18.441, "vehicles": ["Heavy-Duty Fire Engine", "4x4 Wildland Vehicle", "Dive Vehicle"], "response_time_base": 8, "coverage_radius": 12}, "salt_river": {"name": "Salt River Fire Station", "lat": -33.93, "lon": 18.465, "vehicles": ["Water Tanker", "Rapid Intervention Vehicle", "4x4 Wildland Vehicle"], "response_time_base": 7, "coverage_radius": 9}, "wynberg": {"name": "Wynberg Fire Station", "lat": -34.001, "lon": 18.475, "vehicles": ["Heavy-Duty Fire Engine", "CAFS Unit", "Incident Command Vehicle"], "response_time_base": 9, "coverage_radius": 10}};
        var activeFireMarkers = {};
        var fireCount = 0;
        
        // Add fire stations to map
        Object.keys(fireStations).forEach(function(stationId) {
            var station = fireStations[stationId];
            L.marker([station.lat, station.lon], {
                icon: L.divIcon({
                    className: 'fire-station-icon',
                    html: '🚒',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('<b>' + station.name + '</b><br>Fire Station<br>Vehicles: ' + station.vehicles.length);
        });
        
        // Click handler for starting fires
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            
            // Start fire at clicked location
            startFire(lat, lon);
        });
        
        function startFire(lat, lon) {
            fireCount++;
            var fireData = simulateFireStart(lat, lon);
            
            // Add fire marker to map
            var fireMarker = L.circleMarker([lat, lon], {
                color: 'red',
                fillColor: 'orange',
                fillOpacity: 0.7,
                radius: 8 + fireData.fire_data.intensity / 10,
                weight: 3
            }).addTo(map);
            
            activeFireMarkers[fireData.fire_id] = fireMarker;
            
            // Update control panel with multi-fire coordination
            updateControlPanel(fireData);
            
            // Simulate fire growth
            simulateFireGrowth(fireData.fire_id, fireMarker);
        }
        
        function simulateFireStart(lat, lon) {
            var fireId = 'fire_' + fireCount + '_' + Date.now();
            var intensity = Math.floor(Math.random() * 60) + 30;
            var size = 0.1 + Math.random() * 0.4;
            
            return {
                fire_id: fireId,
                fire_data: {
                    lat: lat,
                    lon: lon,
                    intensity: intensity,
                    size: size,
                    terrain: getTerrainType(lat, lon),
                    status: 'active'
                },
                recommendations: generateRecommendations(lat, lon, intensity, size)
            };
        }
        
        function getTerrainType(lat, lon) {
            if (lat <= -34.355 && lon <= 18.425) return "coast";
            if (lat >= -34.345 && lon >= 18.445) return "water";
            if (lat > -34.355 && lat < -34.345 && lon > 18.425 && lon < 18.445) return "rough";
            return "residential";
        }
        
        function generateRecommendations(lat, lon, intensity, size) {
            var closestStation = findClosestStation(lat, lon);
            var activeFireCount = Object.keys(activeFireMarkers).length + 1;
            var isMultiFire = activeFireCount > 1;
            
            var recommendations = {
                fire_assessment: {
                    level: intensity > 70 ? "HIGH" : intensity > 40 ? "MEDIUM" : "LOW",
                    intensity: intensity
                },
                primary_response: {
                    station: closestStation.name,
                    distance_km: Math.round(closestStation.distance * 10) / 10,
                    estimated_response_time: Math.round(closestStation.response_time_base + (closestStation.distance / 10) * 2)
                },
                vehicle_deployment: generateVehicleDeployment(intensity, closestStation),
                timeline: [
                    {time_range: "0-2 minutes", actions: ["Alert and dispatch", "Route calculation"]},
                    {time_range: "2-8 minutes", actions: ["Units en route", "Establish command"]},
                    {time_range: "8+ minutes", actions: ["On-scene operations", "Fire suppression"]}
                ]
            };
            
            // Add multi-fire coordination if multiple fires active
            if (isMultiFire) {
                recommendations.multi_fire_coordination = {
                    total_active_fires: activeFireCount,
                    resource_competition: {
                        resource_strain: activeFireCount > 5 ? "HIGH" : activeFireCount > 2 ? "MEDIUM" : "LOW",
                        fire_to_station_ratio: activeFireCount / Object.keys(fireStations).length
                    },
                    coordination_strategy: {
                        command_structure: activeFireCount > 2 ? "Unified Command" : "Divided Command",
                        mutual_aid_required: activeFireCount > Object.keys(fireStations).length,
                        specialized_recommendations: activeFireCount >= 3 ? [
                            "Establish Incident Command Post for unified coordination",
                            "Deploy aerial surveillance for multi-fire monitoring"
                        ] : []
                    },
                    inter_fire_risks: calculateInterFireRisks(),
                    resource_priorities: calculateFirePriorities()
                };
            }
            
            return recommendations;
        }
        
        function findClosestStation(lat, lon) {
            var closestStation = null;
            var minDistance = Infinity;
            
            Object.keys(fireStations).forEach(function(stationId) {
                var station = fireStations[stationId];
                var distance = calculateDistance(lat, lon, station.lat, station.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestStation = station;
                    closestStation.distance = distance;
                }
            });
            
            return closestStation;
        }
        
        function calculateInterFireRisks() {
            var risks = [];
            var firePositions = Object.keys(activeFireMarkers).map(function(fireId) {
                var marker = activeFireMarkers[fireId];
                return {
                    id: fireId,
                    lat: marker.getLatLng().lat,
                    lon: marker.getLatLng().lng
                };
            });
            
            for (var i = 0; i < firePositions.length; i++) {
                for (var j = i + 1; j < firePositions.length; j++) {
                    var distance = calculateDistance(
                        firePositions[i].lat, firePositions[i].lon,
                        firePositions[j].lat, firePositions[j].lon
                    );
                    
                    if (distance < 3.0) {
                        risks.push({
                            fire1_id: firePositions[i].id,
                            fire2_id: firePositions[j].id,
                            distance_km: Math.round(distance * 100) / 100,
                            convergence_risk: distance < 1.5 ? "HIGH" : "MEDIUM",
                            recommended_action: distance < 1.0 ? "Deploy separation barrier teams" : "Monitor convergence closely"
                        });
                    }
                }
            }
            
            return risks;
        }
        
        function calculateFirePriorities() {
            return Object.keys(activeFireMarkers).map(function(fireId, index) {
                var baseScore = 30 + Math.random() * 40;
                return {
                    fire_id: fireId,
                    priority_score: Math.round(baseScore * 10) / 10,
                    recommended_stations: Math.min(3, Math.max(1, Math.floor(baseScore / 25)))
                };
            }).sort(function(a, b) { return b.priority_score - a.priority_score; });
        }
        
        function generateVehicleDeployment(intensity, station) {
            var vehicles = [];
            
            if (station.vehicles.includes("Rapid Intervention Vehicle")) {
                vehicles.push({vehicle_type: "Rapid Intervention Vehicle", priority: 1});
            }
            
            if (intensity > 60 && station.vehicles.includes("Heavy-Duty Fire Engine")) {
                vehicles.push({vehicle_type: "Heavy-Duty Fire Engine", priority: 2});
            }
            
            if (station.vehicles.includes("4x4 Wildland Vehicle")) {
                vehicles.push({vehicle_type: "4x4 Wildland Vehicle", priority: 3});
            }
            
            return vehicles.slice(0, 3);
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function updateControlPanel(fireData) {
            var statusDiv = document.getElementById('fire-status');
            var fire = fireData.fire_data;
            var rec = fireData.recommendations;
            
            var html = '<div class="fire-info status-' + fire.status + '">';
            html += '<h3>🔥 Fire Incident: ' + fireData.fire_id + '</h3>';
            html += '<p><strong>Location:</strong> ' + fire.lat.toFixed(4) + ', ' + fire.lon.toFixed(4) + '</p>';
            html += '<p><strong>Threat Level:</strong> ' + rec.fire_assessment.level + ' (' + fire.intensity + '% intensity)</p>';
            html += '<p><strong>Size:</strong> ' + fire.size.toFixed(2) + ' hectares</p>';
            html += '<p><strong>Terrain:</strong> ' + fire.terrain + '</p>';
            
            // Multi-fire coordination display
            if (rec.multi_fire_coordination) {
                html += '<div class="multi-fire-coordination">';
                html += '<h4>🔄 Multi-Fire Coordination Status</h4>';
                
                var coord = rec.multi_fire_coordination;
                html += '<p><strong>Total Active Fires:</strong> ' + coord.total_active_fires + '</p>';
                html += '<p><strong>Resource Strain:</strong> ' + coord.resource_competition.resource_strain + '</p>';
                html += '<p><strong>Command Structure:</strong> ' + coord.coordination_strategy.command_structure + '</p>';
                
                if (coord.coordination_strategy.mutual_aid_required) {
                    html += '<div style="background: #ffebee; padding: 8px; margin: 5px 0; border-radius: 3px; border: 1px solid #f44336;">';
                    html += '<strong>⚠️ MUTUAL AID REQUIRED</strong><br>';
                    html += 'Additional resources needed from neighboring departments';
                    html += '</div>';
                }
                
                if (coord.inter_fire_risks && coord.inter_fire_risks.length > 0) {
                    html += '<h5>🔥 Inter-Fire Risks</h5>';
                    coord.inter_fire_risks.forEach(function(risk) {
                        var riskColor = risk.convergence_risk === 'HIGH' ? '#f44336' : '#ff9800';
                        html += '<div style="background: ' + riskColor + '20; padding: 6px; margin: 3px 0; border-radius: 3px; border: 1px solid ' + riskColor + ';">';
                        html += '<strong>Fire Convergence Risk: ' + risk.convergence_risk + '</strong><br>';
                        html += 'Distance: ' + risk.distance_km + ' km<br>';
                        html += 'Action: ' + risk.recommended_action;
                        html += '</div>';
                    });
                }
                
                if (coord.resource_priorities) {
                    html += '<h5>🎯 Fire Priorities</h5>';
                    coord.resource_priorities.slice(0, 3).forEach(function(priority) {
                        html += '<div style="padding: 5px; margin: 2px 0; border-left: 3px solid #4caf50;">';
                        html += '<strong>' + priority.fire_id.replace('fire_', 'Fire ') + ':</strong> Priority ' + priority.priority_score;
                        html += ' (' + priority.recommended_stations + ' stations)';
                        html += '</div>';
                    });
                }
                
                if (coord.coordination_strategy.specialized_recommendations.length > 0) {
                    html += '<h5>📋 Coordination Recommendations</h5>';
                    html += '<ul>';
                    coord.coordination_strategy.specialized_recommendations.forEach(function(rec) {
                        html += '<li>' + rec + '</li>';
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            html += '<div class="recommendation">';
            html += '<h4>🚨 Primary Response</h4>';
            html += '<p><strong>Station:</strong> ' + rec.primary_response.station + '</p>';
            html += '<p><strong>Distance:</strong> ' + rec.primary_response.distance_km + ' km</p>';
            html += '<p><strong>ETA:</strong> ' + rec.primary_response.estimated_response_time + ' minutes</p>';
            html += '</div>';
            
            html += '<div class="recommendation">';
            html += '<h4>🚒 Vehicle Deployment</h4>';
            rec.vehicle_deployment.forEach(function(vehicle) {
                html += '<div class="vehicle-deployment">';
                html += '<strong>Priority ' + vehicle.priority + ':</strong> ' + vehicle.vehicle_type;
                html += '</div>';
            });
            html += '</div>';
            
            html += '</div>';
            
            statusDiv.innerHTML = html;
        }
        
        function simulateFireGrowth(fireId, marker) {
            var growthCount = 0;
            var maxGrowth = 10 + Math.floor(Math.random() * 15);
            
            var growthInterval = setInterval(function() {
                if (growthCount >= maxGrowth) {
                    clearInterval(growthInterval);
                    
                    // Update marker to show controlled status
                    marker.setStyle({
                        color: 'orange',
                        fillColor: 'yellow',
                        fillOpacity: 0.5
                    });
                    
                    // Add suppression update
                    var statusDiv = document.getElementById('fire-status');
                    var updateHtml = `
                        <div style="background: #e8f5e8; padding: 8px; margin: 5px 0; border-radius: 3px; border-left: 3px solid #4caf50;">
                            <strong>✅ Fire ${fireId} Status Update</strong><br>
                            <div style="font-size: 0.9em; margin-top: 4px;">
                                Status: <strong>CONTROLLED</strong> | Containment: <strong>85%</strong><br>
                                Suppression progress: <strong>Successful</strong>
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML += updateHtml;
                    statusDiv.scrollTop = statusDiv.scrollHeight;
                    
                    return;
                }
                
                // Grow fire marker
                var currentRadius = marker.getRadius();
                marker.setRadius(Math.min(currentRadius + 1, 20));
                
                // Add periodic updates
                if (growthCount % 3 === 0) {
                    var statusDiv = document.getElementById('fire-status');
                    var recommendations = [
                        "Deploying additional suppression units",
                        "Establishing firebreaks on eastern perimeter",
                        "Coordinating water tanker operations",
                        "Monitoring wind direction changes"
                    ];
                    var updateHtml = `
                        <div style="background: #fff3e0; padding: 6px; margin: 3px 0; border-radius: 3px; font-size: 0.9em;">
                            <strong>🚒 Fire ${fireId} Update (${Math.floor(growthCount * 2)} min)</strong><br>
                            <div style="margin-top: 4px;">
                                <b>🎯 Live Priorities:</b><br>
                                ${recommendations.map(r => `<div style="margin-left: 10px; font-size: 0.9em;">• ${r}</div>`).join('')}
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML += updateHtml;
                    statusDiv.scrollTop = statusDiv.scrollHeight;
                }
                
                growthCount++;
            }, 2000);
        }
    </script>
</body>
</html>
